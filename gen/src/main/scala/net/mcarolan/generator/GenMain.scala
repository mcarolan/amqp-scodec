package net.mcarolan.generator

import java.io.{BufferedWriter, FileWriter}

import cats.effect.{ExitCode, IO, IOApp, Resource}

import scala.xml.XML

object GenMain extends IOApp {
  private val amqpClassesOutputPath: String =
    "./core/src/main/scala/net/mcarolan/amqpscodec/AmqpClasses.scala"


  override def run(args: List[String]): IO[ExitCode] = {
    Resource.fromAutoCloseable(IO(new BufferedWriter(new FileWriter(amqpClassesOutputPath)))).use { classesOutputWriter =>
      IO {
        val elem = XML.loadFile("./gen/src/main/resources/amqp0-9-1.xml")
        val generator = Generator(elem)

        classesOutputWriter.write("package net.mcarolan.amqpscodec")
        classesOutputWriter.newLine()
        classesOutputWriter.write("import AmqpTypes._")
        classesOutputWriter.newLine()
        classesOutputWriter.write("import import scodec.Encoder")
        classesOutputWriter.newLine()
        classesOutputWriter.write("//note: this file has been auto generated by the program in the `gen` sub project")
        classesOutputWriter.newLine()

        classesOutputWriter.write(generator.defineClasses)
        classesOutputWriter.flush()
      }
    }.as(ExitCode.Success)
  }
}
